!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.EnfaceAuth=t():e.EnfaceAuth=t()}(this,(function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){var s=n(1);e.exports=function(){return s.randomBytes(16)}},function(e,t){e.exports=require("crypto")},function(e,t){for(var n=[],s=0;s<256;++s)n[s]=(s+256).toString(16).substr(1);e.exports=function(e,t){var s=t||0,r=n;return[r[e[s++]],r[e[s++]],r[e[s++]],r[e[s++]],"-",r[e[s++]],r[e[s++]],"-",r[e[s++]],r[e[s++]],"-",r[e[s++]],r[e[s++]],"-",r[e[s++]],r[e[s++]],r[e[s++]],r[e[s++]],r[e[s++]],r[e[s++]]].join("")}},function(e,t){t.COMMAND_BIO_AUTH="bioauth",t.COMMAND_BLOCKCHAIN_AUTH="bcauth",t.COMMAND_CHECK="check",t.COMMAND_READY="ready",t.COMMAND_SUCCESS="success",t.COMMAND_AUTH="auth",t.COMMAND_TOKEN="token",t.COMMAND_FAILED="failed",t.COMMAND_ERROR="error",t.COMMAND_USER_INFO="userInfo",t.HTTP_URI="/enfaceauth",t.AES_CIPHER="aes-256-cbc",t.NEXT_REQUEST_TIME_FRAME=5e3,t.AUTHORIZATION_TIME_FRAME=6e5},function(e,t,n){"use strict";function s(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}n.r(t),n.d(t,"EnfaceAuth",(function(){return c}));var r=n(5),i=n(3),o=n(8),c=function(){function e(t){var n=this,s=t.debug,r=t.httpServer,c=t.projectId,a=t.secretCode,l=t.fields,u=t.callbackUrl;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._DEBUG=!!s,this.projectId=c,this.secretCode=Buffer.from(a,"base64"),this.callbackUrl=u,this.callbackUrl.endsWith("/")&&(this.callbackUrl=this.callbackUrl.substring(0,this.callbackUrl.length-1)),this.sessions={},this.fields=l||"",r?(this.callbackUrl+=i.HTTP_URI,this.log("[EnfaceAuth constructor] Using HTTP/S server"),r.post(i.HTTP_URI,(function(e,t){if(n.log("[EnfaceAuth] POST REQUEST', ".concat(e.path,", ").concat(e.body)),n.newClient({client:t}),o.enfaceCors(t),e.body instanceof Object)n.request({client:t,data:JSON.stringify(e.body)});else{var s="";e.on("data",(function(e){s+=e.toString()})),e.on("end",(function(){n.request({client:t,data:s})}))}})).options((function(e,t){return regeneratorRuntime.async((function(e){for(;;)switch(e.prev=e.next){case 0:o.enfaceCors(t),t.end();case 2:case"end":return e.stop()}}))}))):this.log("[EnfaceAuth] sockets are not supported in this version")}var t,n,c;return t=e,(n=[{key:"log",value:function(e){this._DEBUG&&console.log(e)}},{key:"logError",value:function(e){this._DEBUG&&console.error(e)}},{key:"request",value:function(e){var t,n,s,r,i;return regeneratorRuntime.async((function(o){for(;;)switch(o.prev=o.next){case 0:return t=e.client,n=e.data,this.log("[EnfaceAuth.request], ".concat(n)),o.prev=2,o.next=5,regeneratorRuntime.awrap(this.readMessage({client:t,data:n}));case 5:s=o.sent,r=s.response,i=s.closeConnection,t.end(JSON.stringify(r)),i&&this.finalizeSession(t),o.next=17;break;case 12:o.prev=12,o.t0=o.catch(2),this.logError("[EnfaceAuth.request]', ".concat(o.t0.message)),this.errorResponse({client:t,message:o.t0}),this.finalizeSession(t);case 17:case"end":return o.stop()}}),null,this,[[2,12]])}},{key:"readMessage",value:function(e){var t=this,n=e.client,s=e.data;return new Promise((function(e){t.log("[EnfaceAuth.readMessage] data, ".concat(JSON.stringify(s),", client.clientId, ").concat(n.clientId)),t.sessions[n.clientId].resolver=e;try{s=JSON.parse(s)}catch(e){return t.logError("[EnfaceAuth.readMessage], ".concat(e.message)),t.errorResponse({client:n,message:"Wrong data received ".concat(s)})}switch(s._){case i.COMMAND_AUTH:return t.responseInit({client:n,data:s});case i.COMMAND_CHECK:return t.responseCheck({client:n,sessionId:s.sessionId});case i.COMMAND_BLOCKCHAIN_AUTH:return t.responseBlockchainAuth({client:n,data:s});default:return t.errorResponse({client:n,message:"Unknown command ".concat(s._)})}}))}},{key:"newClient",value:function(e){var t=this,n=e.client;this.log("[EnfaceAuth.newClient]");var s=r();this.sessions[s]={client:n,sessionId:r(),activated:!1,resolver:null},n.clientId=s,setTimeout((function(){t.finalizeSession({clientId:s})}),i.AUTHORIZATION_TIME_FRAME)}},{key:"switchSession",value:function(e){var t=e.client,n=e.clientId;return this.log("[EnfaceAuth.switchSession] to clientId, ".concat(n)),this.sessions[n]?(this.sessions[t.clientId]&&delete this.sessions[t.clientId].client,this.sessions[n].resolver=this.sessions[t.clientId].resolver,this.finalizeSession({clientId:t.clientId}),t.clientId=n,!0):this.errorResponse({client:t,message:"Failed to get session params for client ".concat(n)})}},{key:"responseInit",value:function(e){var t,n,s;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(t=e.client,n=e.data,this.log("[EnfaceAuth.responseInit] data, ".concat(n)),!n.clientId){r.next=4;break}return r.abrupt("return",this.switchSession({client:t,clientId:n.clientId}));case 4:return s=t.clientId,r.abrupt("return",this.resolve({client:t,data:{_:n._,token:o.encrypt([this.sessions[t.clientId].sessionId,this.callbackUrl,n._].join("|"),this.secretCode),id:this.projectId,clientId:s,fields:this.fields}}));case 6:case"end":return r.stop()}}),null,this)}},{key:"responseCheck",value:function(e){var t=e.client,n=e.sessionId;this.log("[EnfaceAuth.responseCheck], sessionId, ".concat(n));var s=this.findSessionById(n);return s?s.activated?this.errorResponse({client:t,message:"Client already activated"}):(s.activated=!0,this.resolve({client:t,data:{_:i.COMMAND_READY}})):this.errorResponse({client:t,message:"Client not found"})}},{key:"responseBlockchainAuth",value:function(e){var t,n,s;return regeneratorRuntime.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(t=e.client,n=e.data,this.log("[EnfaceAuth.responseBlockchainAuth] sessionId, ".concat(n.sessionId,", ").concat(n.alias,", ").concat(n.fields)),s=this.findSessionById(n.sessionId)){r.next=5;break}return r.abrupt("return",this.errorResponse({client:t,message:"Client not found."}));case 5:return this.finalResponse({client:t,data:{_:i.COMMAND_BIO_AUTH,result:!0}}),r.abrupt("return",this.finalResponse({client:s.client,data:{_:i.COMMAND_USER_INFO,userInfo:{alias:n.alias,fields:n.fields}}}));case 7:case"end":return r.stop()}}),null,this)}},{key:"errorResponse",value:function(e){var t=e.client,n=e.message;return this.logError("[EnfaceAuth.errorResponse], ".concat(n)),this.finalResponse({client:t,data:{_:i.COMMAND_ERROR,message:n}}),!1}},{key:"finalResponse",value:function(e){var t=e.client,n=e.data;this.log("[EnfaceAuth.finalResponse], ".concat(n)),this.resolve({client:t,data:n,closeConnection:!0})}},{key:"resolve",value:function(e){var t=e.client,n=e.data,s=e.closeConnection;this.log("[EnfaceAuth.resolve] client.clientId, data, ".concat(t.clientId,", ").concat(n));var r=this.sessions[t.clientId];r&&r.resolver&&(r.resolver({response:n,closeConnection:!!s}),delete r.resolver)}},{key:"finalizeSession",value:function(e){var t=e.clientId;this.log("[EnfaceAuth.finalizeSession] clientId ".concat(t)),this.sessions[t]&&this.closeClient({client:this.sessions[t].client}),delete this.sessions[t]}},{key:"closeClient",value:function(e){var t=e.client;if(this.log("[EnfaceAuth.closeClient] client, ".concat(!!t)),t)try{t.end("timeout")}catch(e){this.logError("[closeClient.error], ".concat(e.message))}}},{key:"findSessionById",value:function(e){for(var t=0,n=Object.values(this.sessions);t<n.length;t++){var s=n[t];if(s.sessionId===e)return s}return null}}])&&s(t.prototype,n),c&&s(t,c),e}()},function(e,t,n){var s=n(6),r=n(7),i=r;i.v1=s,i.v4=r,e.exports=i},function(e,t,n){var s,r,i=n(0),o=n(2),c=0,a=0;e.exports=function(e,t,n){var l=t&&n||0,u=t||[],f=(e=e||{}).node||s,d=void 0!==e.clockseq?e.clockseq:r;if(null==f||null==d){var h=i();null==f&&(f=s=[1|h[0],h[1],h[2],h[3],h[4],h[5]]),null==d&&(d=r=16383&(h[6]<<8|h[7]))}var v=void 0!==e.msecs?e.msecs:(new Date).getTime(),p=void 0!==e.nsecs?e.nsecs:a+1,g=v-c+(p-a)/1e4;if(g<0&&void 0===e.clockseq&&(d=d+1&16383),(g<0||v>c)&&void 0===e.nsecs&&(p=0),p>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");c=v,a=p,r=d;var A=(1e4*(268435455&(v+=122192928e5))+p)%4294967296;u[l++]=A>>>24&255,u[l++]=A>>>16&255,u[l++]=A>>>8&255,u[l++]=255&A;var I=v/4294967296*1e4&268435455;u[l++]=I>>>8&255,u[l++]=255&I,u[l++]=I>>>24&15|16,u[l++]=I>>>16&255,u[l++]=d>>>8|128,u[l++]=255&d;for(var y=0;y<6;++y)u[l+y]=f[y];return t||o(u)}},function(e,t,n){var s=n(0),r=n(2);e.exports=function(e,t,n){var i=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var o=(e=e||{}).random||(e.rng||s)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var c=0;c<16;++c)t[i+c]=o[c];return t||r(o)}},function(e,t,n){var s=n(1),r=n(3);t.encrypt=function(e,t){var n=s.randomBytes(16),i=s.createCipheriv(r.AES_CIPHER,Buffer.from(t),n),o=i.update(e);return o=Buffer.concat([o,i.final()]),"".concat(n.toString("hex")).concat(o.toString("hex"))},t.decrypt=function(e,t){var n=Buffer.from(e.substr(0,32),"hex"),i=Buffer.from(e.substr(32),"hex"),o=s.createDecipheriv(r.AES_CIPHER,Buffer.from(t),n),c=o.update(i);return(c=Buffer.concat([c,o.final()])).toString()},t.isUuid=function(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)},t.enfaceCors=function(e){e.header({"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range"})}}])}));